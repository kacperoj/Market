@model IEnumerable<Market.Web.Core.ViewModels.MySaleViewModel>
@using Market.Web.Core.Models

@{
    ViewData["Title"] = "Otrzymane Zam贸wienia";
}

<div class="container mt-4 mb-5">
    <h1 class="fw-bold mb-4 border-bottom pb-3"> Otrzymane Zam贸wienia</h1>

    @if (!Model.Any())
    {
        <div class="alert alert-info py-4">
            <i class="bi bi-info-circle me-2"></i> Nie masz jeszcze 偶adnych sprzedanych przedmiot贸w.
        </div>
    }
    else
    {
        <div class="table-responsive shadow-sm rounded-3">
            <table class="table table-hover align-middle mb-0">
                <thead class="text-secondary small text-uppercase">
                    <tr>
                        <th scope="col" class="py-3 ps-4">Zam贸wienie</th>
                        <th scope="col" class="py-3">Kupujcy / Adres</th>
                        <th scope="col" class="py-3 text-center">Status</th>
                        <th scope="col" class="py-3 text-end pe-4">Akcje</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <!-- KOLUMNA 1: INFO O ZAMWIENIU -->
                            <td class="ps-4">
                                <span class="fw-bold d-block">#@item.OrderId</span>
                                <small class="text-muted">@item.OrderDate.ToString("dd.MM.yyyy HH:mm")</small>
                                <div class="mt-1">
                                    <a asp-controller="Auctions" asp-action="Details" asp-route-id="@item.AuctionId" class="text-decoration-none fw-bold small">
                                        @item.AuctionTitle
                                    </a>
                                </div>
                                <div class="text-primary fw-bold mt-1">
                                    @item.TotalPrice.ToString("C")
                                </div>
                                @if(item.IsCompanyPurchase)
                                {
                                    <span class="badge bg-warning text-dark mt-1" title="@item.InvoiceDataString">Faktura VAT</span>
                                }
                            </td>

                            <td>
                                <div class="d-flex align-items-center mb-1">
                                    <i class="bi bi-person-circle me-2 text-secondary"></i>
                                    <strong>@item.BuyerName</strong>
                                    <small class="text-muted ms-1">(<a href="mailto:@item.BuyerEmail" class="text-reset">@item.BuyerEmail</a>)</small>
                                </div>
                                <div class="small p-2 rounded border text-muted" style="max-width: 300px;">
                                    <i class="bi bi-truck me-1"></i> @item.ShippingAddressString
                                </div>
                            </td>

                            <td class="text-center">
                                @{
                                    string badgeClass = item.Status switch {
                                        OrderStatus.Pending => "bg-warning text-dark",
                                        OrderStatus.Paid => "bg-info text-dark",
                                        OrderStatus.Shipped => "bg-primary",
                                        OrderStatus.Completed => "bg-success",
                                        OrderStatus.Cancelled => "bg-danger",
                                        _ => "bg-secondary"
                                    };
                                }
                                <span class="badge @badgeClass rounded-pill px-3 py-2">
                                    @item.Status.ToString()
                                </span>
                            </td>

                            <td class="text-end pe-4">
                                <div class="d-flex flex-column gap-2 align-items-end">
                                    
                                    @if(item.Status == OrderStatus.Pending)
                                    {
                                        <form asp-action="UpdateOrderStatus" method="post">
                                            <input type="hidden" name="orderId" value="@item.OrderId" />
                                            <input type="hidden" name="newStatus" value="Paid" />
                                            <button type="submit" class="btn btn-sm btn-success w-100 disabled-pending-btn" title="Oznacz jako opacone (po otrzymaniu przelewu)">
                                                <i class="bi bi-cash-coin me-1"></i> Otrzymano wpat
                                            </button>
                                        </form>
                                    }

                                    @if(item.Status == OrderStatus.Paid)
                                    {
                                        <form asp-action="UpdateOrderStatus" method="post">
                                            <input type="hidden" name="orderId" value="@item.OrderId" />
                                            <input type="hidden" name="newStatus" value="Shipped" />
                                            <button type="submit" class="btn btn-sm btn-primary w-100">
                                                <i class="bi bi-box-seam me-1"></i> Wysano towar
                                            </button>
                                        </form>
                                    }

                                    @if(item.Status == OrderStatus.Shipped)
                                    {
                                        <div class="text-muted small fst-italic">Czekamy na odbi贸r</div>
                                    }

                                    @if(item.Status != OrderStatus.Cancelled && item.Status != OrderStatus.Completed)
                                    {
                                        <form asp-action="UpdateOrderStatus" method="post" onsubmit="return confirm('Czy na pewno anulowa to zam贸wienie?');">
                                            <input type="hidden" name="orderId" value="@item.OrderId" />
                                            <input type="hidden" name="newStatus" value="Cancelled" />
                                            <button type="submit" class="btn btn-sm btn-link text-danger text-decoration-none py-0 mt-1">
                                                Anuluj
                                            </button>
                                        </form>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>